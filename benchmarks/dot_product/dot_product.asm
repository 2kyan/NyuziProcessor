; 
; Copyright 2011-2012 Jeff Bush
; 
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
; 
;     http://www.apache.org/licenses/LICENSE-2.0
; 
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
; 


;
; Compute dot products of an array of vectors with a constant vector
;

;
; struct Vector {
;     float pX, pY, pZ;	
;     float dotProduct;
; };
;

							VECTOR_STRUCT_SIZE = 16
							NUM_STRANDS = 4

ComputeProducts				.enterscope
							; Params
							.regalias pVector s0		
							.regalias vectorCount s1
							.regalias uX vf0
							.regalias uY vf1
							.regalias uZ vf2
						
							; Local variables
							.regalias pX vf3
							.regalias pY vf4
							.regalias pZ vf5
							.regalias sum vf6

ComputeLoop					; Load elements from 16 structures into vector regs
							pX = mem_l[pVector, VECTOR_STRUCT_SIZE]
							pVector = pVector + 4
							pY = mem_l[pVector, VECTOR_STRUCT_SIZE]
							pVector = pVector + 4
							pZ = mem_l[pVector, VECTOR_STRUCT_SIZE]
							pVector = pVector + 4

							; Compute dot product
							pX = pX * uX
							pY = pY * uY
							pZ = pZ * uZ
							sum = pX + pY
							sum = sum + pZ

							; Write back result
							mem_l[pVector, VECTOR_STRUCT_SIZE] = sum
							
							; Loop
							pVector = pVector + (64 - 12)
							vectorCount = vectorCount - 16
							if vectorCount goto ComputeLoop

							pc = link
							.exitscope


_start						.enterscope
							.regalias strandID s2 
							.regalias structOffset s3 

							s0 = 0xf
							cr30 = s0				; Start all strands		
							strandID = cr0				; Get my strand ID

							; Load pointer and count
							s0 = &@bodyStructs		; Dest
							structOffset = strandID * (16 * VECTOR_STRUCT_SIZE)	; Block size
							s0 = s0 + structOffset			; Offset
							s1 = 256 / NUM_STRANDS

							; Load reference vector
							s5 = &refVector
							s4 = mem_l[s5]
							v2 = s4
							s4 = mem_l[s5 + 4]
							v3 = s4
							s4 = mem_l[s5 + 8]
							v4 = s4

							call ComputeProducts

							; Wait for all strands to finish
							s0 = &running_strands
retry						s1 = mem_sync[s0]
							s1 = s1 - 1
							s2 = s1
							mem_sync[s0] = s1
							if !s1 goto retry

wait_done					if s2 goto wait_done	; Will fall through on last ref (s2 = 1)
							cr31 = s0				; halt
							
running_strands				.word 4					
refVector					.float 2.5, 3.2, 5.1
							.exitscope
							
;
; from random import random
; for x in range(256):
; 	print '\t.float ' + str(random()) + ',' + str(random()) + ',' + str(random()) + ',0.0';
;					
bodyStructs
	.float 0.0313329074384,0.0482699588014,0.303843307806,0.0
	.float 0.389258748825,0.614948854975,0.5903026113,0.0
	.float 0.626640162716,0.663380937347,0.139718016282,0.0
	.float 0.273436606358,0.109970526739,0.94926230665,0.0
	.float 0.973193896547,0.871882277113,0.525850629316,0.0
	.float 0.489699138146,0.580403013878,0.342155293199,0.0
	.float 0.905298572811,0.132970451756,0.265402097141,0.0
	.float 0.60656658382,0.480458854458,0.38401741025,0.0
	.float 0.52648169531,0.697945738098,0.595573379025,0.0
	.float 0.564392295821,0.189063415133,0.285133841984,0.0
	.float 0.921021640664,0.414461054507,0.0846465937483,0.0
	.float 0.0493943887132,0.355235652162,0.43937015533,0.0
	.float 0.542062057285,0.385121591746,0.744216600421,0.0
	.float 0.808187952294,0.0519753761429,0.0843959358488,0.0
	.float 0.638870061218,0.232864204774,0.853178545175,0.0
	.float 0.501411957028,0.230037640044,0.185678328707,0.0
	.float 0.748210236903,0.0939446618932,0.670407560519,0.0
	.float 0.473052880471,0.812649905571,0.823394929849,0.0
	.float 0.599398713948,0.203923276678,0.868403364442,0.0
	.float 0.873440225345,0.14045493836,0.864874399779,0.0
	.float 0.0943285256411,0.211520827125,0.624517257253,0.0
	.float 0.166129004622,0.0917975740857,0.317006081089,0.0
	.float 0.489660450052,0.513656865561,0.558342175231,0.0
	.float 0.827120813486,0.206896892908,0.134221063397,0.0
	.float 0.15111334976,0.702547821373,0.269246982756,0.0
	.float 0.165181505159,0.494929294274,0.511713538596,0.0
	.float 0.275389025572,0.870736208865,0.0963801622198,0.0
	.float 0.5433851512,0.937727021685,0.174760050412,0.0
	.float 0.230931096534,0.510282277649,0.240647905906,0.0
	.float 0.572922999296,0.200051708628,0.998496569424,0.0
	.float 0.965429018795,0.394977786542,0.816537094012,0.0
	.float 0.830585783461,0.0311608119278,0.60202635606,0.0
	.float 0.783336904582,0.180757295228,0.9546761523,0.0
	.float 0.218436520143,0.27081986227,0.115040067992,0.0
	.float 0.549190243419,0.892177384541,0.436147929388,0.0
	.float 0.294594516885,0.137533322298,0.408152387017,0.0
	.float 0.876854232719,0.309624400384,0.49025803512,0.0
	.float 0.813375499162,0.0825738092334,0.0108679898457,0.0
	.float 0.442392036244,0.666093216984,0.169937888409,0.0
	.float 0.140921915545,0.289563559915,0.735537144141,0.0
	.float 0.654587778752,0.826983792085,0.783260967425,0.0
	.float 0.0031116841546,0.0298738912935,0.403263938762,0.0
	.float 0.849923004713,0.386262160647,0.861160723388,0.0
	.float 0.751881712687,0.0937512094372,0.303165336956,0.0
	.float 0.974689005688,0.0283928038346,0.7134589042,0.0
	.float 0.131298258801,0.499708866068,0.852840413395,0.0
	.float 0.0580391129341,0.0702717059003,0.0223059298535,0.0
	.float 0.957708198896,0.734665758272,0.520524751568,0.0
	.float 0.11943570909,0.483060826902,0.362646620101,0.0
	.float 0.465506275061,0.0229214884288,0.72448156727,0.0
	.float 0.657803547065,0.180414520469,0.0189719123572,0.0
	.float 0.906384486729,0.179746600183,0.566275415089,0.0
	.float 0.160651997462,0.124208540929,0.140719584349,0.0
	.float 0.226873217664,0.982465000662,0.0285705627131,0.0
	.float 0.163953319904,0.145962499437,0.182265705919,0.0
	.float 0.394479837094,0.465022681598,0.964626542131,0.0
	.float 0.0312753994696,0.162965786564,0.175314791098,0.0
	.float 0.922517436548,0.214846554774,0.692967805364,0.0
	.float 0.282446583522,0.0657735821294,0.188582411511,0.0
	.float 0.635705158565,0.885862215155,0.292041193081,0.0
	.float 0.19141793076,0.529147043178,0.534602999054,0.0
	.float 0.553384032836,0.506534035089,0.445574947244,0.0
	.float 0.345923649385,0.188498339868,0.731274969145,0.0
	.float 0.995329521315,0.0778884234704,0.0603803861717,0.0
	.float 0.0509657192899,0.351255555019,0.207518021097,0.0
	.float 0.783156116542,0.925934451455,0.485739448588,0.0
	.float 0.264089407185,0.722687681411,0.405756691419,0.0
	.float 0.840206336155,0.142546978373,0.170024373713,0.0
	.float 0.677459001107,0.270318525526,0.654881150498,0.0
	.float 0.221413286724,0.895704852269,0.671324793025,0.0
	.float 0.734381076353,0.854126966295,0.806509313849,0.0
	.float 0.997422029628,0.952513367621,0.324070723585,0.0
	.float 0.343378957797,0.892343600049,0.501480496669,0.0
	.float 0.456014118027,0.13978974621,0.235037459057,0.0
	.float 0.0356859192255,0.252115796096,0.392559196261,0.0
	.float 0.317309562953,0.11805688608,0.673653244392,0.0
	.float 0.280108755006,0.258847896725,0.779126374407,0.0
	.float 0.323631250944,0.868229653895,0.668223479859,0.0
	.float 0.249555886134,0.744683820783,0.264590013653,0.0
	.float 0.559703414217,0.284338374537,0.794192556953,0.0
	.float 0.321429188279,0.424092356663,0.118212594956,0.0
	.float 0.551634572616,0.460181273347,0.116230737272,0.0
	.float 0.657713085495,0.983866673493,0.681054600665,0.0
	.float 0.749080852311,0.898513787581,0.562114672236,0.0
	.float 0.80257375641,0.949497708049,0.689734398134,0.0
	.float 0.494708014209,0.938521665687,0.195095779967,0.0
	.float 0.788001684961,0.835770144728,0.540172477052,0.0
	.float 0.927911623423,0.144430353259,0.140412350353,0.0
	.float 0.247830520563,0.294007496709,0.0539519233585,0.0
	.float 0.148188011794,0.973423570833,0.326336029922,0.0
	.float 0.872387131486,0.409131313875,0.932866887276,0.0
	.float 0.995029974445,0.394227571446,0.20416206502,0.0
	.float 0.678214614067,0.183065408794,0.549013565815,0.0
	.float 0.139168172726,0.0874545139507,0.236689831905,0.0
	.float 0.225511563517,0.557204152808,0.596229735927,0.0
	.float 0.552974571893,0.516682126542,0.930109466067,0.0
	.float 0.0538863201136,0.949708882482,0.387057557997,0.0
	.float 0.590884704489,0.976406207859,0.970277620862,0.0
	.float 0.143623461096,0.199900365562,0.505092501335,0.0
	.float 0.277977338024,0.460531167096,0.477250907256,0.0
	.float 0.249938577437,0.221933507346,0.70757415331,0.0
	.float 0.383672733209,0.215537590802,0.00582918941138,0.0
	.float 0.434228886512,0.57862962656,0.390980259755,0.0
	.float 0.638542083157,0.10130609974,0.373524460744,0.0
	.float 0.427353997906,0.52756086993,0.503446745843,0.0
	.float 0.8237682764,0.0894090764606,0.121964031317,0.0
	.float 0.743882296768,0.230429231476,0.473591233698,0.0
	.float 0.284340894675,0.838039197316,0.355460055561,0.0
	.float 0.368851293895,0.493608260133,0.318717938829,0.0
	.float 0.704427897268,0.659095370694,0.633483506941,0.0
	.float 0.617253238594,0.200261565048,0.555295955004,0.0
	.float 0.656608590456,0.00301880170656,0.644120942884,0.0
	.float 0.435769366356,0.529261905958,0.651170731111,0.0
	.float 0.444975204466,0.0642033025259,0.14682619785,0.0
	.float 0.524646695319,0.646083166625,0.740449344612,0.0
	.float 0.429835884438,0.65696016162,0.713613465839,0.0
	.float 0.657719317381,0.100952881672,0.91213492587,0.0
	.float 0.253717417942,0.554527965705,0.447145769899,0.0
	.float 0.0849094477822,0.107994610153,0.639476956729,0.0
	.float 0.247373325544,0.975628906156,0.419868246402,0.0
	.float 0.890399799865,0.251342950107,0.28070812785,0.0
	.float 0.785719534799,0.969251118581,0.699016035177,0.0
	.float 0.88276766818,0.342991943342,0.909941232849,0.0
	.float 0.731410023593,0.903034082773,0.660296847179,0.0
	.float 0.927421550388,0.219749325302,0.00948235438305,0.0
	.float 0.692048623442,0.77792015128,0.016635328714,0.0
	.float 0.36196343269,0.363438507242,0.493278801338,0.0
	.float 0.994384915543,0.688247841417,0.756505504336,0.0
	.float 0.484599734338,0.0871387772965,0.66690351833,0.0
	.float 0.495898219497,0.820299242786,0.836292646233,0.0
	.float 0.673485927333,0.421160053897,0.454787860392,0.0
	.float 0.424622659591,0.688718706845,0.589030653513,0.0
	.float 0.52640907466,0.40130373207,0.764517229264,0.0
	.float 0.331345012889,0.730823568382,0.657460720938,0.0
	.float 0.682460018967,0.502607386057,0.476422385372,0.0
	.float 0.333090007897,0.709735580141,0.0757039033399,0.0
	.float 0.911967743297,0.357379598929,0.827639343022,0.0
	.float 0.903718885945,0.34759128564,0.0884330417405,0.0
	.float 0.879699992671,0.70570524484,0.380197083292,0.0
	.float 0.562705603861,0.18913905165,0.521920052374,0.0
	.float 0.492040429577,0.676536698566,0.542337820464,0.0
	.float 0.88375892543,0.390728818237,0.92668382935,0.0
	.float 0.078835443058,0.231875891904,0.0488875408449,0.0
	.float 0.413711326384,0.613044597387,0.826826976342,0.0
	.float 0.375360995579,0.389941671465,0.236920367413,0.0
	.float 0.371046596648,0.350757887465,0.973148877149,0.0
	.float 0.356651622793,0.0745536288515,0.332545320272,0.0
	.float 0.482783365375,0.241009393211,0.0864132430938,0.0
	.float 0.897982748485,0.937883521499,0.306236202013,0.0
	.float 0.969841806322,0.529830543612,0.216324626783,0.0
	.float 0.480881937267,0.468641897914,0.768248585478,0.0
	.float 0.267800136576,0.848006398168,0.61847864849,0.0
	.float 0.979136170232,0.748586890611,0.100126179922,0.0
	.float 0.570887345752,0.148422448212,0.82060829779,0.0
	.float 0.968354974708,0.524479293848,0.388265934609,0.0
	.float 0.31382892812,0.338516189614,0.785184271619,0.0
	.float 0.205489363341,0.82909942409,0.6995711083,0.0
	.float 0.0547331531964,0.988029623006,0.379007213216,0.0
	.float 0.326335555331,0.0095196973426,0.146764574084,0.0
	.float 0.591595460167,0.949411424334,0.97966114757,0.0
	.float 0.887092279279,0.730417190782,0.319261384507,0.0
	.float 0.930879497255,0.0544812389643,0.478094215129,0.0
	.float 0.940704404016,0.670010012291,0.0771816401474,0.0
	.float 0.31084761654,0.0835225680808,0.126750237306,0.0
	.float 0.0298493947215,0.490348396136,0.644422233517,0.0
	.float 0.698624235549,0.47495169932,0.456623802347,0.0
	.float 0.379248693036,0.139144465667,0.885375503264,0.0
	.float 0.481514149654,0.807834998536,0.637444882836,0.0
	.float 0.981921838139,0.822948107086,0.383447433631,0.0
	.float 0.183916882365,0.393209583731,0.329609435478,0.0
	.float 0.134777826641,0.221978952254,0.739029983089,0.0
	.float 0.670112134374,0.333352181325,0.0944182989724,0.0
	.float 0.631883453347,0.404103702747,0.95063193788,0.0
	.float 0.213930326851,0.740715651063,0.707662192999,0.0
	.float 0.854955773936,0.621040734538,0.702010228391,0.0
	.float 0.761216754778,0.658230638234,0.0456432106628,0.0
	.float 0.583167661708,0.344185429213,0.060759147966,0.0
	.float 0.842067460664,0.379328790059,0.535306400125,0.0
	.float 0.664785592919,0.031361279509,0.793624965987,0.0
	.float 0.17934747396,0.751233326245,0.710181071287,0.0
	.float 0.0577008103977,0.629888272341,0.128834478287,0.0
	.float 0.0926467980434,0.311363660973,0.885869359058,0.0
	.float 0.847407275258,0.290945956227,0.116089998463,0.0
	.float 0.0142777319761,0.0913496415302,0.777259656328,0.0
	.float 0.569092526721,0.127824817235,0.286856257855,0.0
	.float 0.246960548353,0.77819748566,0.566262713453,0.0
	.float 0.584477442907,0.905096104,0.402175992865,0.0
	.float 0.600667990238,0.255134029651,0.840467517482,0.0
	.float 0.74445503422,0.679745129058,0.266291615328,0.0
	.float 0.384555086083,0.519276519859,0.505157299804,0.0
	.float 0.678583390293,0.726842152617,0.769687660501,0.0
	.float 0.223318960514,0.513551166274,0.933892785972,0.0
	.float 0.439751004993,0.931653890278,0.329403642754,0.0
	.float 0.875768836276,0.824706962851,0.84999150045,0.0
	.float 0.438605068231,0.326466678296,0.372535563868,0.0
	.float 0.529819405486,0.518673732465,0.00972419898833,0.0
	.float 0.16105583017,0.4109515224,0.992150866819,0.0
	.float 0.126165211668,0.565380217506,0.560172952939,0.0
	.float 0.0426435315506,0.421499897159,0.117430033107,0.0
	.float 0.834013003281,0.246910036184,0.884120629269,0.0
	.float 0.702698119799,0.628261761732,0.485953534824,0.0
	.float 0.895424716866,0.906471458135,0.102842523498,0.0
	.float 0.861641729403,0.605773631697,0.963291277516,0.0
	.float 0.518501273918,0.772877634881,0.196906389807,0.0
	.float 0.203963262462,0.0981843447739,0.158938447435,0.0
	.float 0.593527755578,0.207899596874,0.131237225349,0.0
	.float 0.119817395039,0.265527085772,0.944597982409,0.0
	.float 0.0470834165402,0.668412966783,0.40657466006,0.0
	.float 0.260174178184,0.517829978062,0.691114750714,0.0
	.float 0.344690532669,0.965656490644,0.144837035439,0.0
	.float 0.753722593021,0.6469249362,0.557391467248,0.0
	.float 0.662669399991,0.978127744242,0.823535604995,0.0
	.float 0.323465252663,0.131451331046,0.461076711531,0.0
	.float 0.428617786494,0.487095809187,0.81547871163,0.0
	.float 0.449640908626,0.390447429651,0.314112251331,0.0
	.float 0.645799461537,0.238057848965,0.117102606029,0.0
	.float 0.785231945582,0.531702363326,0.0952744971911,0.0
	.float 0.612936777768,0.704705107561,0.331498665427,0.0
	.float 0.225626112375,0.175471666823,0.919065005757,0.0
	.float 0.474383180812,0.448984975109,0.988486106364,0.0
	.float 0.766320629733,0.0966221779665,0.68644075424,0.0
	.float 0.348171459167,0.984941637744,0.440036145825,0.0
	.float 0.116039317729,0.0157969145793,0.0525226431705,0.0
	.float 0.844426167009,0.944445134931,0.754849142708,0.0
	.float 0.000410210659118,0.940185231485,0.333240861559,0.0
	.float 0.546356433622,0.118469715624,0.188591749556,0.0
	.float 0.994457911603,0.878987482781,0.0993765639731,0.0
	.float 0.268004346929,0.596661120796,0.163673350665,0.0
	.float 0.485630666221,0.699152678911,0.108472388419,0.0
	.float 0.315912043421,0.302362205512,0.886619976883,0.0
	.float 0.876595959331,0.233838374423,0.714339660231,0.0
	.float 0.467261665048,0.76865834077,0.272525499951,0.0
	.float 0.00845631808586,0.735978356175,0.487658890904,0.0
	.float 0.875662526226,0.560829419957,0.93403861225,0.0
	.float 0.805975908448,0.770441511003,0.521341263848,0.0
	.float 0.33634930228,0.888184197639,0.444015704318,0.0
	.float 0.457268100907,0.00494517866223,0.480620634367,0.0
	.float 0.0935608541098,0.984810290264,0.877168560667,0.0
	.float 0.346061055399,0.763239977042,0.58507974607,0.0
	.float 0.441007697804,0.589313759473,0.436323149534,0.0
	.float 0.742177623548,0.941992408276,0.914048460873,0.0
	.float 0.758039021517,0.663478033192,0.267007728037,0.0
	.float 0.0210093559362,0.955047221207,0.381803636489,0.0
	.float 0.822899737938,0.418190956637,0.0658754084577,0.0
	.float 0.834472967198,0.979229931473,0.774163503677,0.0
	.float 0.90755421362,0.286885899789,0.807221401612,0.0
	.float 0.965167707799,0.00821907399069,0.727999678897,0.0
	.float 0.730083507135,0.841499230625,0.441690980753,0.0
	.float 0.43138668243,0.107133208622,0.58058386012,0.0
	.float 0.785123968465,0.338663906805,0.283462499406,0.0
	.float 0.432197175053,0.419132721322,0.375956648212,0.0
	.float 0.688729906796,0.646281336742,0.886195930348,0.0
	.float 0.360175800958,0.455644966352,0.410616394658,0.0
	.float 0.701265532462,0.695074240083,0.53880402007,0.0
	.float 0.921008892703,0.426002904541,0.458086235899,0.0
	.float 0.724930102601,0.782638311789,0.831403176841,0.0

							
